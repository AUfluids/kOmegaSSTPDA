#!/bin/bash
cd "${0%/*}" || exit   # Run from this directory
. "${WM_PROJECT_DIR:?}"/wmake/scripts/AllwmakeParseArguments
#------------------------------------------------------------------------------

moduleName="kOmegaSSTPDA_symbolic_regression"

if [ "$FOAM_MODULE_PREFIX" = false ]
then
    echo "Compilation of $moduleName is disabled (prefix=false)"
    exit 0
fi

date "+%Y-%m-%d %H:%M:%S %z" 2>/dev/null || echo "date is unknown"
echo "Starting compile of $moduleName"
echo "  $WM_COMPILER $WM_COMPILER_TYPE compiler"
echo "  ${WM_OPTIONS}, with ${WM_MPLIB} ${FOAM_MPI}"
echo "  prefix = ${FOAM_MODULE_PREFIX:-default (user)}"
echo


unset prevVersion
if [ -e foamVersionThisIsCompiledFor ]
then
    prevVersion=$(<foamVersionThisIsCompiledFor)
fi

if [ -n "$prevVersion" ]
then
    if [ "$prevVersion" = "$WM_PROJECT_VERSION" ]
    then
        echo "  Rebuilding for OpenFOAM = $WM_PROJECT_VERSION ($FOAM_API)."
        echo
    else
        echo "  Previously compiled for OpenFOAM = $prevVersion"
        echo "  but now using OpenFOAM = $WM_PROJECT_VERSION ($FOAM_API)."
        echo "     Use ./Allwclean before compiling"
        echo
        exit 42
    fi
else
    echo "  Building for OpenFOAM = $WM_PROJECT_VERSION ($FOAM_API)."
    echo
    echo "${WM_PROJECT_VERSION:-unknown}" >| foamVersionThisIsCompiledFor
fi

# Check and setup ExprTK if needed
if [ -f "kOmegaSSTPDA_symbolic_regression/Make/options.exprtk" ]; then
    if [ ! -d "kOmegaSSTPDA_symbolic_regression/external/exprtk" ]; then
        echo "  ExprTK not found. Attempting to download..."
        cd kOmegaSSTPDA_symbolic_regression
        mkdir -p external
        cd external
        if command -v git >/dev/null 2>&1; then
            git clone https://github.com/ArashPartow/exprtk.git 2>&1 | head -5
            if [ -d "exprtk" ]; then
                echo "  ✓ ExprTK downloaded successfully"
            else
                echo "  ⚠ Warning: ExprTK download failed. Code will compile without expression evaluation."
            fi
        else
            echo "  ⚠ Warning: git not found. Cannot download ExprTK automatically."
            echo "            Please download manually: git clone https://github.com/ArashPartow/exprtk.git external/exprtk"
        fi
        cd ../..
    else
        echo "  ✓ ExprTK found in kOmegaSSTPDA_symbolic_regression/external/exprtk"
    fi
    
    # Setup Make/options for ExprTK if options.exprtk exists and ExprTK is available
    if [ -d "kOmegaSSTPDA_symbolic_regression/external/exprtk" ]; then
        if [ ! -f "kOmegaSSTPDA_symbolic_regression/Make/options" ] || \
           ! grep -q "EXPRTK_DIR" "kOmegaSSTPDA_symbolic_regression/Make/options" 2>/dev/null; then
            echo "  Setting up Make/options for ExprTK..."
            # Create clean Make/options file with ExprTK support
            cat > kOmegaSSTPDA_symbolic_regression/Make/options << 'EOFMAKE'

/* Failsafe - user location */
ifeq (,$(strip $(FOAM_MODULE_APPBIN)))
    FOAM_MODULE_APPBIN = $(FOAM_USER_APPBIN)
endif
ifeq (,$(strip $(FOAM_MODULE_LIBBIN)))
    FOAM_MODULE_LIBBIN = $(FOAM_USER_LIBBIN)
endif

include $(GENERAL_RULES)/module-path-user

EXPRTK_DIR = ./external/exprtk

EXE_INC = \
    -I$(LIB_SRC)/finiteVolume/lnInclude \
    -I$(LIB_SRC)/meshTools/lnInclude \
    -I$(LIB_SRC)/transportModels \
    -I$(LIB_SRC)/TurbulenceModels/turbulenceModels/lnInclude \
    -I$(LIB_SRC)/TurbulenceModels/incompressible/lnInclude \
    -I./ \
    -I$(EXPRTK_DIR) \
    -DEXPRTK_AVAILABLE

LIB_LIBS = \
    -lturbulenceModels \
    -lfiniteVolume \
    -lmeshTools \
    -lincompressibleTransportModels \
    -lincompressibleTurbulenceModels \
    -lstdc++
EOFMAKE
        fi
    else
        echo "  Note: Using Make/options without ExprTK (expressions will use hardcoded coefficients)"
    fi
    echo
fi

# Compile symbolic regression version (includes all features from incompressible)
# This replaces kOmegaSSTPDA_incompressible
echo "Compiling kOmegaSSTPDA_symbolic_regression..."
wmake kOmegaSSTPDA_symbolic_regression

# Compile compressible version (if needed)
wmake kOmegaSSTPDA_compressible

# Compile utility
wmake libso calcPDAFields

#------------------------------------------------------------------------------
